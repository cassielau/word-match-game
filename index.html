<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>è¯æ±‡è¿è¿çœ‹ Â· Candy / Green çš®è‚¤ + éŸ³æ•ˆ + å½©å¸¦é›¨</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#18324a;
  --muted:#607089;
  --shadow:0 10px 26px rgba(0,0,0,.08);
  --tile-radius:18px;
}
/* ========== Candy ä¸»é¢˜ï¼ˆé»˜è®¤ï¼‰ ========== */
body[data-theme="candy"]{
  --bg-top:#fdf6ff; --bg-mid:#f6fbff; --bg-bot:#f1fff7;
  --panel:#ffffff; --tile:#ffffff;
  --accent:#ff62b0; --accent2:#ffa4d1; --accent-emer:#10b981; --blue:#6aa9ff; --danger:#ef4444;
  --border-soft:rgba(255,98,176,.25);
  --border-card:rgba(255,98,176,.22);
  --progress-a:#ff66b5; --progress-b:#ff9bd2;
}
/* ========== ç»¿è‰²æ¸…æ–°ä¸»é¢˜ ========== */
body[data-theme="green"]{
  --bg-top:#ecfff7; --bg-mid:#f7fffb; --bg-bot:#ffffff;
  --panel:#ffffff; --tile:#ffffff;
  --accent:#16a34a; --accent2:#22c55e; --accent-emer:#0ea5e9; --blue:#3b82f6; --danger:#dc2626;
  --border-soft:#cfe9dc; --border-card:#d6efe3;
  --progress-a:#34d399; --progress-b:#10b981;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:"Nunito",system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans",sans-serif;
  color:var(--ink);
  background:
   radial-gradient(1200px 600px at 10% -20%, rgba(255,196,229,.28) 0%, transparent 60%),
   radial-gradient(1200px 600px at 100% 120%, rgba(186,230,253,.28) 0%, transparent 60%),
   linear-gradient(180deg,var(--bg-top),var(--bg-mid) 60%,var(--bg-bot));
  display:flex;flex-direction:column; overflow-x:hidden;
}
/* header */
header{display:flex;align-items:center;gap:12px;padding:12px 16px;position:sticky;top:0;background:rgba(255,255,255,.7);border-bottom:1px solid var(--border-soft);backdrop-filter:saturate(130%) blur(10px)}
.brand{display:flex;align-items:center;gap:10px;padding:6px 10px;border-radius:12px;background:linear-gradient(135deg,var(--accent2),var(--accent));color:#fff;box-shadow:0 8px 20px rgba(0,0,0,.08)}
.logo{width:26px;height:26px;border-radius:8px;background:rgba(255,255,255,.2);display:grid;place-items:center;font-weight:900}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-left:auto;align-items:center}
select,button,input{background:#fff;color:var(--ink);border:1px solid var(--border-soft);border-radius:14px;padding:9px 12px;font-size:14px;outline:none;transition:.2s;box-shadow:0 6px 18px rgba(0,0,0,.06)}
button.primary{background:linear-gradient(135deg,var(--accent2),var(--accent));border:none;color:#fff;font-weight:900;letter-spacing:.2px}
button.ghost{background:#fff}
button:hover{transform:translateY(-1px)}
.pill{background:#fff;border:1px solid var(--border-soft);border-radius:999px;padding:7px 12px;font-size:12px;box-shadow:0 6px 18px rgba(0,0,0,.05)}

main{width:min(1250px,96%);margin:14px auto 26px;display:grid;grid-template-columns:360px 1fr;gap:16px}
@media (max-width:980px){main{grid-template-columns:1fr}}
.panel{background:var(--panel);border:1px solid var(--border-card);border-radius:18px;padding:14px;box-shadow:var(--shadow)}
.panel h3{margin:0 0 12px;font-size:16px;color:var(--accent);letter-spacing:.2px}
.rowlabel{font-size:12px;color:var(--muted)}
.meta{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.meta .card{background:linear-gradient(180deg,#fff,#fff8fb);border:1px solid var(--border-card);border-radius:14px;padding:10px}
.grid{position:relative}
#board{
  background:
    radial-gradient(400px 160px at 10% 10%, rgba(255,240,250,.9), transparent 60%),
    radial-gradient(500px 200px at 90% 90%, rgba(240,253,250,.9), transparent 70%);
  min-height:420px;border-radius:16px; overflow:hidden;
}
/* hud */
.hud{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:6px 0 12px}
.hud-left{display:flex;align-items:center;gap:12px}
.progress{position:relative;width:280px;height:14px;background:linear-gradient(180deg,#fff0f8,#f2faff);border:1px solid var(--border-soft);border-radius:999px;box-shadow:inset 0 2px 6px rgba(0,0,0,.06)}
.progress-inner{position:absolute;left:0;top:0;height:100%;border-radius:999px;background:linear-gradient(90deg,var(--progress-a),var(--progress-b));box-shadow:0 2px 6px rgba(0,0,0,.06)}
.progress span{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:12px;color:#a00656;font-weight:800}
.comboChip{background:linear-gradient(135deg,#fff0f8,#ffe3f2);border:1px solid var(--border-soft);border-radius:999px;padding:6px 12px;font-weight:900;color:#a00656;box-shadow:0 8px 18px rgba(0,0,0,.05)}
.iconbtn{border:1px solid var(--border-soft);border-radius:12px;background:#fff;padding:8px 12px;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,.05)}
.iconbtn.off{opacity:.6}

/* tiles */
.tiles{display:grid;grid-template-columns:repeat(3,minmax(200px,1fr));gap:14px}
@media (max-width:1000px){.tiles{grid-template-columns:repeat(2,minmax(160px,1fr))}}
.tile{
  position:relative; background:linear-gradient(180deg,#ffffff,#fff2f8);
  border:2px solid var(--border-soft); border-radius:var(--tile-radius);
  padding:18px;min-height:124px;display:flex;align-items:center;justify-content:center;text-align:center;
  font-weight:900;line-height:1.25;cursor:pointer;
  transition:transform .12s,border-color .2s,opacity .25s,box-shadow .2s,filter .2s;
  box-shadow:0 8px 22px rgba(0,0,0,.06), inset 0 2px 0 rgba(255,255,255,.95);
  overflow:hidden; transform:scale(.98); opacity:0; /* forå…¥åœºåŠ¨æ•ˆ */
}
.tile.appear{animation:tileIn .35s ease both}
@keyframes tileIn{0%{transform:scale(.85);opacity:0} 100%{transform:scale(1);opacity:1}}
.tile:before{content:""; position:absolute; left:-30%; top:-50%; width:160%; height:140%; background:radial-gradient(ellipse at 20% 20%, rgba(255,255,255,.6), transparent 40%); transform:rotate(12deg)}
.tile:hover{transform:translateY(-2px);box-shadow:0 10px 26px rgba(0,0,0,.12)}
.tile.selected{outline:3px solid var(--blue); border-color:var(--blue); box-shadow:0 0 0 6px rgba(0,0,0,.06) inset, 0 10px 26px rgba(0,0,0,.12); filter:saturate(1.05)}
.tile.matched{background:linear-gradient(145deg,#ecfff5,#ffe6f4); border-color:#b8eccf; color:#0b3b2e; opacity:.92; animation:candyPulse .45s ease}
@keyframes candyPulse{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}
svg.links{position:absolute;inset:0;pointer-events:none}

.score{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
.textarea{width:100%;min-height:160px;background:#fff7fb;border:1px solid var(--border-card);border-radius:12px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px}

/* toasts */
.comboToast{position:fixed;left:50%;top:18%;transform:translate(-50%,-50%) scale(1);background:#a00656;color:#ffeef7;padding:10px 16px;border-radius:999px;font-weight:900;opacity:0;transition:opacity .25s,transform .25s;box-shadow:0 10px 26px rgba(0,0,0,.08)}
.comboToast.show{opacity:1;transform:translate(-50%,-50%) scale(1.06)}
.penaltyToast{position:fixed;left:50%;top:26%;transform:translate(-50%,-50%) scale(1);background:#7f1d1d;color:#ffecec;padding:8px 14px;border-radius:999px;font-weight:900;opacity:0;transition:opacity .25s,transform .25s;box-shadow:0 10px 26px rgba(0,0,0,.08)}
.penaltyToast.show{opacity:1;transform:translate(-50%,-50%) scale(1.06)}

.liveBoard li{margin:2px 0}
.small{font-size:12px;color:#b3126c}
.panel .meta .card input{width:100%}

/* confetti åŸºç¡€æ ·å¼ */
.confetti{
  position:absolute; width:10px; height:14px; will-change:transform,opacity;
  top:-20px; opacity:0.9; pointer-events:none;
  border-radius:2px;
}
</style>
</head>
<body data-theme="candy">
  <header>
    <div class="brand"><span class="logo">ğŸ¬</span> <b>Word Match</b></div>
    <h3 id="title" style="margin:0 0 0 6px">è¯æ±‡è¿è¿çœ‹ Â· Candy / Green çš®è‚¤ï¼ˆæœ¬åœ°/åœ¨çº¿ï¼‰</h3>
    <div class="controls">
      <span class="pill" id="lvlPill">Level 1</span>
      <span class="pill" id="pairsPill">10 pairs</span>
      <span class="pill"><span id="timeLeft">120</span>s</span>
      <select id="mode" title="æ¨¡å¼">
        <option value="cn-en">CN â‡„ EN</option>
        <option value="en-def">EN â‡„ Definition</option>
        <option value="assoc">Association</option>
      </select>
      <select id="players" title="ç©å®¶æ•°">
        <option value="1">1 Player</option>
        <option value="2">2 Players</option>
        <option value="3">3 Players</option>
        <option value="4">4 Players</option>
        <option value="5">5 Players</option>
        <option value="6">6 Players</option>
      </select>
      <input id="timer" type="number" min="0" value="120" title="Timer (seconds)"/>
      <input id="seed" type="text" value="" placeholder="Room/Seed" title="Use same seed for same board" />
      <select id="theme" title="çš®è‚¤">
        <option value="candy">ğŸ¬ Candy</option>
        <option value="green">ğŸŒ¿ Green</option>
      </select>
      <button id="start" class="primary">Start å¼€å§‹</button>
      <button id="shuffle" class="ghost">Shuffle æ´—ç‰Œ</button>
      <span class="pill" id="totalPill">Total æ€»ç§¯åˆ†: â€”</span>
    </div>
  </header>

  <main>
    <section class="panel">
      <h3>è®¾ç½® / Setup</h3>
      <div class="meta">
        <div class="card">
          <div class="rowlabel">Mode æ¨¡å¼</div>
          <div id="statusMode">â€”</div>
        </div>
        <div class="card">
          <div class="rowlabel">Turn å›åˆ</div>
          <div class="score" id="scoreWrap"></div>
        </div>
        <div class="card">
          <div class="rowlabel">Live Leaderboard å®æ—¶æ’è¡Œ</div>
          <ol id="liveBoard" class="liveBoard rowlabel" style="margin:6px 0 0; padding-left:18px"></ol>
        </div>
      </div>

      <h3 style="margin-top:10px">åœ¨çº¿æ¨¡å¼ï¼ˆ50+ å¹¶å‘ï¼‰</h3>
      <div class="meta">
        <div class="card">
          <div class="rowlabel">æ˜µç§° Name</div>
          <input id="olName" placeholder="å¦‚ï¼šAlice" />
        </div>
        <div class="card">
          <div class="rowlabel">æˆ¿é—´å· Room IDï¼ˆåŒå­¦ä»¬å¡«åŒä¸€ä¸ªï¼‰</div>
          <input id="olRoom" placeholder="å¦‚ï¼šecon-10A" list="recentRooms" />
          <datalist id="recentRooms"></datalist>
          <div class="small">å¯ä»ä¸‹æ‹‰ä¸­é€‰æ‹©ä½ è¿™ä¸ªåå­—ä½¿ç”¨è¿‡çš„æˆ¿é—´</div>
        </div>
        <div class="card">
          <div class="rowlabel">çŠ¶æ€ / Status</div>
          <div id="olStatus" class="small">æœªè¿æ¥ Not connected</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button id="olApplyCfg" class="ghost">ç²˜è´´ Firebase é…ç½®</button>
        <button id="olJoin" class="primary">åŠ å…¥åœ¨çº¿ Join</button>
        <button id="olLeave" class="ghost">ç¦»å¼€ Leave</button>
      </div>
      <details style="margin-top:6px"><summary class="rowlabel">æŸ¥çœ‹/ä¿®æ”¹ Firebase é…ç½® JSON</summary>
        <textarea id="olCfg" class="textarea" placeholder='{"apiKey":"...","authDomain":"...","databaseURL":"...","projectId":"...","appId":"..."}'></textarea>
        <div class="small">å»ºè®®ï¼šå¼€å¯ <b>Anonymous Auth</b>ï¼ŒRealtime Database ä½¿ç”¨æ¨èè§„åˆ™ã€‚</div>
      </details>

      <h3 style="margin-top:10px">é¢˜åº“ / Dataset</h3>
      <p class="rowlabel">å¯ç›´æ¥ä½¿ç”¨é¢„ç½®é¢˜åº“ï¼Œæˆ–ç²˜è´´ä½ è‡ªå·±çš„é…å¯¹æ•°æ®ï¼ˆterm | ä¸­æ–‡/å®šä¹‰ï¼Œæ¯è¡Œä¸€å¯¹ï¼‰ï¼š</p>
      <textarea id="data" class="textarea" spellcheck="false"></textarea>
      <p class="small">Tips: Start ç”Ÿæˆå…³å¡ï¼›Shuffle ä»…é‡æ’å½“å‰å…³å¡ã€‚æ”¯æŒè¿å‡»ä¸ä»ç¬¬3å…³èµ·çš„è¿é”™æ‰£åˆ†ã€‚</p>
    </section>

    <section class="panel">
      <h3>æ£‹ç›˜ / Board</h3>
      <div class="hud">
        <div class="hud-left">
          <div class="progress" id="progOuter" aria-label="Progress">
            <div class="progress-inner" id="progInner" style="width:0%"></div>
            <span id="progText">0%</span>
          </div>
          <span class="comboChip" id="comboChip" aria-live="polite">Combo x1</span>
        </div>
        <button class="iconbtn" id="sndBtn" title="Sound on/off">ğŸ”Š</button>
      </div>
      <div id="board" class="grid" aria-live="polite">
        <svg class="links" id="links" xmlns="http://www.w3.org/2000/svg"></svg>
        <div id="tiles" class="tiles"></div>
      </div>
    </section>
  </main>

  <div class="comboToast" id="comboToast">Combo x2!</div>
  <div class="penaltyToast" id="penaltyToast">-1</div>

<script>
'use strict';
const $ = (id)=>document.getElementById(id);
const setText = (id, t)=>{ const el=$(id); if(el) el.textContent=String(t); };

/* ä¸»é¢˜åˆ‡æ¢ */
const themeEl = $('theme');
function applyTheme(v){
  document.body.setAttribute('data-theme', v);
  localStorage.setItem('wmb_theme', v);
}
themeEl?.addEventListener('change', ()=>applyTheme(themeEl.value));
(function initTheme(){ const t=localStorage.getItem('wmb_theme')||'candy'; if(themeEl) themeEl.value=t; applyTheme(t); })();

/* é¢˜åº“ç¤ºä¾‹ */
const samples={
  'cn-en':`business | ä¼ä¸šï¼šç»„ç»‡ï¼Œç”¨äºç”Ÿäº§å•†å“å’ŒæœåŠ¡
organisation | ç»„ç»‡ï¼šä¸ºç‰¹å®šç›®çš„è€Œæˆç«‹çš„ç¾¤ä½“
Goods | å•†å“ï¼šæœ‰å½¢äº§å“ï¼Œå¦‚æ‰‹æœºæˆ–é‹å­
Services | æœåŠ¡ï¼šæ— å½¢äº§å“ï¼Œå¦‚é“¶è¡Œæˆ–æ´—è½¦
Output | äº§é‡ï¼šä¸€ä¸ªäººã€æœºå™¨æˆ–å·¥å‚ç”Ÿäº§çš„æ•°é‡
Premises | åœºæ‰€ï¼šå•†åº—æˆ–ä¼ä¸šä½¿ç”¨çš„å»ºç­‘å’ŒåœŸåœ°
Human resources | äººåŠ›èµ„æºï¼šè´Ÿè´£æ‹›è˜ã€åŸ¹è®­å’Œå‘˜å·¥äº‹åŠ¡çš„éƒ¨é—¨
Consumer goods | æ¶ˆè´¹å“ï¼šå–ç»™æ™®é€šäººçš„å•†å“å’ŒæœåŠ¡
Producer goods | ç”Ÿäº§èµ„æ–™ï¼šä¼ä¸šé—´äº¤æ˜“çš„å•†å“å’ŒæœåŠ¡
Needs | åŸºæœ¬éœ€æ±‚ï¼šäººç±»ç”Ÿå­˜çš„åŸºæœ¬è¦æ±‚
Wants | æ¬²æœ›ï¼šå¯¹å•†å“å’ŒæœåŠ¡çš„æ¸´æœ›
Finite | æœ‰é™çš„ï¼šæœ‰ç•Œé™çš„
Scarce | ç¨€ç¼ºçš„ï¼šæœ‰é™å¯å¾—çš„èµ„æº
Primary sector | ç¬¬ä¸€äº§ä¸šï¼šå†œä¸šã€æ¸”ä¸šã€é‡‡çŸ¿ä¸š
Secondary sector | ç¬¬äºŒäº§ä¸šï¼šåˆ¶é€ ä¸šï¼Œå°†åŸææ–™è½¬åŒ–ä¸ºäº§å“
Tertiary sector | ç¬¬ä¸‰äº§ä¸šï¼šæœåŠ¡ä¸šï¼Œä¸ºä¸ªäººæˆ–ä¼ä¸šæä¾›æœåŠ¡
Private sector | ç§è¥éƒ¨é—¨ï¼šç”±ä¸ªäººæˆ–å›¢ä½“æ‹¥æœ‰çš„ä¼ä¸š
Public sector | å…¬æœ‰éƒ¨é—¨ï¼šç”±æ”¿åºœæ‹¥æœ‰çš„ä¼ä¸š
Stakeholder | åˆ©ç›Šç›¸å…³è€…ï¼šå¯¹ä¼ä¸šè¿è¥æœ‰å…´è¶£çš„ä¸ªäººæˆ–å›¢ä½“
Entrepreneur | ä¼ä¸šå®¶ï¼šæ‰¿æ‹…é£é™©åˆ›åŠä¼ä¸šçš„äºº`,
  'en-def':`business | an organisation producing goods or services to satisfy needs and wants
organisation | a group formed for a particular purpose
goods | physical products such as phones or shoes
services | non-physical products such as banking or car washing
output | the amount produced by a person, machine, or factory
premises | buildings or land used by a business`,
  'assoc':`needs | wants
finite | infinite
private sector | public sector
primary sector | secondary sector
secondary sector | tertiary sector`
};

const modeEl=$('mode'); const dataEl=$('data'); const playersEl=$('players');
function setModeStatus(){ const map={'cn-en':'CNâ‡„EN','en-def':'ENâ‡„DEF','assoc':'ASSOC'}; setText('statusMode', map[modeEl.value]||'â€”'); }

/* éšæœº & å…³å¡ */
const pairsPerLevel=10; let level=1; let rng=Math.random; let pool=[], fullDataset=[], currentPairs=[]; let phase='initial';
function xmur3(str){let h=1779033703^str.length; for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353); h=(h<<13)|(h>>>19);} return function(){h=Math.imul(h^(h>>>16),2246822507); h=Math.imul(h^(h>>>13),3266489909); return (h^=h>>>16)>>>0;};}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5; t=Math.imul(t^(t>>>15),1|t); t^=t+Math.imul(t^(t>>>7),61|t); return ((t^(t>>>14))>>>0)/4294967296;};}
function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(rng()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr;}
function parsePairs(raw){
  const lines = String(raw||'').split(/\r?\n+/).map(s=>s.trim()).filter(Boolean);
  const out=[]; 
  for(const line of lines){
    const parts=line.split('|');
    if(parts.length>=2){
      const a=(parts[0]||'').trim();
      const b=(parts.slice(1).join('|')||'').trim();
      if(a&&b) out.push([a,b]);
    }
  }
  return out;
}

/* éš¾åº¦ä¸é”™é¢˜ */
let reviewQueue=[]; const usedKeys=new Set(); let poolEasy=[], poolMed=[], poolHard=[];
function estimateDifficulty(a,b){const lenA=(a||'').replace(/[^A-Za-z\u4e00-\u9fa5]/g,'').length; const lenB=(b||'').replace(/[^A-Za-z\u4e00-\u9fa5]/g,'').length; return lenA*0.7+lenB*0.3;}
function bucketize(){const scored=fullDataset.map((p,idx)=>({a:p[0],b:p[1],key:`K${idx}`,score:estimateDifficulty(p[0],p[1])})).sort((x,y)=>x.score-y.score); const n=scored.length; const q1=Math.floor(n/3), q2=Math.floor(n*2/3); poolEasy=scored.slice(0,q1); poolMed=scored.slice(q1,q2); poolHard=scored.slice(q2);} 
function getDifficultyForLevel(lvl){ if(phase==='initial'){ if(lvl<=2) return 'easy'; if(lvl<=4) return 'med'; return 'hard'; } const mod=((lvl-1)%3); return ['easy','med','hard'][mod]; }
function takeFromPool(arr,need){const res=[]; for(const it of arr){ if(res.length>=need) break; if(!usedKeys.has(it.key)) res.push(it);} return res; }

/* DOM */
const tilesWrap=$('tiles'); const linksSvg=$('links');
const lvlPill=$('lvlPill'); const pairsPill=$('pairsPill');
const timerInput=$('timer'); const seedInput=$('seed'); const startBtn=$('start'); const shuffleBtn=$('shuffle');
const totalPill=$('totalPill'); const liveBoard=$('liveBoard'); const comboToast=$('comboToast'); const penaltyToast=$('penaltyToast');
const progInner=$('progInner'); const progText=$('progText'); const comboChip=$('comboChip'); const sndBtn=$('sndBtn');

/* éŸ³æ•ˆåŒ…ï¼ˆWebAudio ç®€æ˜“åˆæˆï¼‰ */
let audioCtx=null; let soundOn=true;
function ensureAudio(){ if(!audioCtx && soundOn){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} } }
function toggleSound(){ soundOn=!soundOn; if(sndBtn){ sndBtn.classList.toggle('off', !soundOn); sndBtn.textContent = soundOn ? 'ğŸ”Š' : 'ğŸ”‡'; } }
function tone(freq=440,dur=140,type='sine',vol=0.05, when=0){
  if(!soundOn) return; ensureAudio(); if(!audioCtx) return;
  const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
  o.type=type; o.frequency.value=freq; g.gain.value=vol;
  const t0=audioCtx.currentTime+when;
  o.connect(g); g.connect(audioCtx.destination);
  // ADSR-ish
  g.gain.setValueAtTime(0,t0);
  g.gain.linearRampToValueAtTime(vol,t0+0.02);
  g.gain.exponentialRampToValueAtTime(0.0001,t0+dur/1000);
  o.start(t0); o.stop(t0+dur/1000);
}
function sfxCorrect(){ // ä¸Šæ‰¬ä¸‰éŸ³
  tone(620,130,'sine',0.05,0); tone(780,130,'triangle',0.05,0.08); tone(930,160,'sine',0.05,0.16);
}
function sfxError(){ // ä½é¢‘é¢¤éŸ³
  tone(220,220,'square',0.04,0); tone(180,220,'square',0.035,0.02);
}
function sfxCombo(n=2){ // é¢¤éŸ³çŸ­è·‘
  const base = 900; for(let i=0;i<n;i++){ tone(base+i*60,90,'sawtooth',0.04,i*0.05); }
}
function vibrate(ms=120){ if(navigator.vibrate) try{ navigator.vibrate(ms); }catch(e){} }
function showCombo(n){ if(n<=1) return; comboToast.textContent=`Combo x${n}! è¿å‡»${n}å€ï¼`; comboToast.classList.add('show'); setTimeout(()=> comboToast.classList.remove('show'),700); }

/* æ‰£åˆ†æç¤ºï¼ˆæ£‹ç›˜å†…ï¼‰ */
function showPenalty(txt='-1'){
  penaltyToast.textContent = txt;
  const board=$('board');
  if(board && penaltyToast.parentNode!==board){ board.appendChild(penaltyToast); }
  penaltyToast.style.position='absolute';
  penaltyToast.style.left='50%';
  penaltyToast.style.top='12px';
  penaltyToast.style.transform='translate(-50%,0)';
  penaltyToast.classList.add('show');
  setTimeout(()=> penaltyToast.classList.remove('show'),650);
}

/* å‡ ä½•/ç‰¹æ•ˆ */
function centerOf(el){ const r=el.getBoundingClientRect(); const br=$('board').getBoundingClientRect(); return {x:r.left-br.left+r.width/2,y:r.top-br.top+r.height/2}; }
function midPoint(a,b){ const A=centerOf(a), B=centerOf(b); return { x:(A.x+B.x)/2, y:(A.y+B.y)/2 }; }
function spawnBubbles(x,y,count=18){
  const board=$('board'); const br=board.getBoundingClientRect(); const relX=x-br.left; const relY=y-br.top;
  const frag=document.createDocumentFragment();
  for(let i=0;i<count;i++){
    const d=document.createElement('div');
    d.className='bubble'; d.style.position='absolute'; d.style.left=relX+'px'; d.style.top=relY+'px';
    const s=6+Math.random()*10; d.style.width=s+'px'; d.style.height=s+'px'; d.style.borderRadius='50%';
    d.style.background=['#ffd1ec','#c7e1ff','#d1fae5','#fee2e2'][i%4];
    d.style.boxShadow='0 2px 10px rgba(0,0,0,.08)'; d.style.pointerEvents='none'; d.style.zIndex=10;
    const dx=(Math.random()*2-1)*80; const dy=-60-Math.random()*60;
    d.animate([{transform:'translate(0,0) scale(1)',opacity:.95},{transform:`translate(${dx}px,${dy}px) scale(${1.2+Math.random()*0.6})`,opacity:0}],{duration:720+Math.random()*420,easing:'cubic-bezier(.2,.8,.2,1)'});
    setTimeout(()=>d.remove(),1300);
    frag.appendChild(d);
  }
  board.appendChild(frag);
}
function spawnBomb(x,y,count=24){
  const board = $('board'); const br = board.getBoundingClientRect(); const relX = x - br.left; const relY = y - br.top;
  const frag=document.createDocumentFragment();
  for(let i=0;i<count;i++){
    const d=document.createElement('div');
    d.className='bomb'; d.style.position='absolute'; d.style.left=relX+'px'; d.style.top=relY+'px';
    const s=4+Math.random()*6; d.style.width=s+'px'; d.style.height=s+'px'; d.style.borderRadius='50%'; d.style.background=['#ff6b6b','#f97316','#fb7185','#ef4444'][i%4];
    d.style.pointerEvents='none'; d.style.zIndex=12;
    const ang=Math.random()*Math.PI*2; const dist=50+Math.random()*70; const tx=Math.cos(ang)*dist; const ty=Math.sin(ang)*dist;
    d.animate([{transform:'translate(0,0) scale(1)',opacity:1},{transform:`translate(${tx}px,${ty}px) scale(${.6+Math.random()*0.6})`,opacity:0}],{duration:560+Math.random()*320,easing:'cubic-bezier(.2,.8,.2,1)'});
    setTimeout(()=>d.remove(),980);
    frag.appendChild(d);
  }
  const label=document.createElement('div');
  label.textContent='ğŸ’£ -1';
  label.style.position='absolute'; label.style.left=(relX-12)+'px'; label.style.top=(relY-8)+'px';
  label.style.fontWeight='900'; label.style.color='#7f1d1d'; label.style.textShadow='0 2px 6px rgba(0,0,0,.12)'; label.style.pointerEvents='none';
  label.animate([{transform:'translateY(0)',opacity:1},{transform:'translateY(-30px)',opacity:0}],{duration:720,easing:'ease-out'});
  setTimeout(()=>label.remove(),760); frag.appendChild(label);
  board.appendChild(frag);
}
function screenShake(){ try{ document.body.animate([{transform:'translate(0,0)'},{transform:'translate(-3px,2px)'},{transform:'translate(3px,-2px)'},{transform:'translate(0,0)'}],{duration:150}); }catch(e){} }

/* æ³¡æ³¡æ¶ˆå¤± */
function bubblePop(el){
  if(!el) return;
  el.classList.add('matched'); el.style.pointerEvents='none';
  const anim = el.animate([
    { transform:'translateY(0) scale(1)', opacity:1, borderRadius:'var(--tile-radius)' },
    { transform:'translateY(-6px) scale(1.06)', opacity:1, borderRadius:'24px' },
    { transform:'translateY(-18px) scale(0.6)', opacity:0, borderRadius:'999px' }
  ], { duration:450, easing:'cubic-bezier(.2,.8,.2,1)' });
  anim.addEventListener('finish', ()=>{ try{ el.remove(); }catch(e){} });
}

/* å½©å¸¦é›¨ï¼ˆé€šå…³åŠ¨æ•ˆï¼‰ */
function confettiRain(duration=900){
  const board = $('board'); const rect = board.getBoundingClientRect();
  const colors = ['#ff66b5','#ffd166','#95f9c3','#6aa9ff','#ffa4d1','#fca5a5'];
  const count = 120;
  for(let i=0;i<count;i++){
    const c = document.createElement('div');
    c.className='confetti';
    c.style.left = (Math.random()*rect.width) + 'px';
    c.style.background = colors[i%colors.length];
    c.style.transform = `rotate(${Math.random()*360}deg)`;
    board.appendChild(c);
    const fall = c.animate([
      { transform:`translateY(-20px) rotate(0deg)`, opacity:1 },
      { transform:`translate(${(Math.random()*2-1)*80}px, ${rect.height+40}px) rotate(${Math.random()*720-360}deg)`, opacity:0.9 }
    ], { duration: duration + Math.random()*600, easing:'cubic-bezier(.2,.8,.2,1)' });
    fall.addEventListener('finish', ()=> c.remove());
  }
}

/* è¿çº¿ */
function drawLink(elA,elB,ok){
  const A=centerOf(elA), B=centerOf(elB);
  const line=document.createElementNS('http://www.w3.org/2000/svg','line');
  line.setAttribute('x1',A.x); line.setAttribute('y1',A.y);
  line.setAttribute('x2',B.x); line.setAttribute('y2',B.y);
  line.setAttribute('stroke', ok?getComputedStyle(document.body).getPropertyValue('--accent')||'#16a34a':'var(--danger)');
  line.setAttribute('stroke-width','6'); line.setAttribute('stroke-linecap','round');
  line.style.filter = 'drop-shadow(0 2px 4px rgba(0,0,0,.12))';
  linksSvg.appendChild(line);
  setTimeout(()=>{ line.style.transition='opacity .5s'; line.style.opacity='0'; setTimeout(()=> line.remove(),600); }, ok?600:300);
}

/* æœ¬åœ°çŠ¶æ€ */
let tiles=[], selected=[], timeLeft=0, timer=null, levelStartAt=0,
    players=1, turn=0, scores=[], streaks=[], wrongStreaks=[];

function renderTotalPill(){ const parts=[]; for(let i=0;i<players;i++){ parts.push(`P${i+1} ${scores[i]||0}`); } totalPill.textContent=`æ€»ç§¯åˆ†/Total: ${parts.join(' Â· ')}`; }
function buildScorePills(){ const wrap=$('scoreWrap'); wrap.innerHTML=''; for(let i=0;i<players;i++){ const pill=document.createElement('span'); pill.className='pill'; pill.id=`pill-${i}`; pill.innerHTML='P'+(i+1)+': <b id="score-'+i+'">'+(scores[i]||0)+'</b>'; pill.style.borderColor=i===turn?getComputedStyle(document.body).getPropertyValue('--accent2'):'var(--border-soft)'; wrap.appendChild(pill);} renderTotalPill(); renderLiveLeaderboard(); }
function updateScorePills(){ for(let i=0;i<players;i++){ const sEl=$(`score-${i}`); if(sEl) sEl.textContent=String(scores[i]||0); const pill=$(`pill-${i}`); if(pill) pill.style.borderColor=i===turn?getComputedStyle(document.body).getPropertyValue('--accent2'):'var(--border-soft)'; } renderTotalPill(); renderLiveLeaderboard(); }
function renderLiveLeaderboard(){ liveBoard.innerHTML = Array.from({length:players},(_,i)=>`<li>${i+1}. P${i+1} â€” ${scores[i]||0} pts${i===turn?' Â· â–¶':''}</li>`).join(''); }

function updateProgress(){
  try{
    const total = currentPairs.length || 1;
    const remainingPairs = Math.max(0, Math.floor(document.querySelectorAll('.tile:not(.matched)').length/2));
    const done = Math.max(0, total - remainingPairs);
    const pct = Math.round(done/total*100);
    if(progInner){ progInner.style.width = pct+'%'; }
    if(progText){ progText.textContent = pct+'%'; }
  }catch(e){}
}
function updateComboChip(){ const n = streaks[turn]||0; if(comboChip){ comboChip.textContent = `Combo x${Math.max(1,n)}`; comboChip.style.opacity = n>1? 1: .6; } }

function dealLevel(){
  const need=pairsPerLevel; let chosen=[];
  while(reviewQueue.length && chosen.length<need){ const it=reviewQueue.shift(); if(it && !usedKeys.has(it.key)) chosen.push(it); }
  const diff=getDifficultyForLevel(level); const src = diff==='easy'? poolEasy : diff==='med'? poolMed : poolHard; const remain=need - chosen.length; if(remain>0){ chosen = chosen.concat(takeFromPool(src, remain)); }
  if(chosen.length<need){ const all=[...poolEasy,...poolMed,...poolHard]; for(const it of all){ if(chosen.length>=need) break; if(!usedKeys.has(it.key) && !chosen.find(x=>x.key===it.key)) chosen.push(it); } }
  if(chosen.length===0 && pool.length){ const fb = pool.slice(0,Math.min(need,pool.length)).map((p,idx)=>({a:p[0],b:p[1],key:`F${level}-${idx}`})); chosen=fb; }
  currentPairs = chosen.map(it=>[it.a,it.b]); chosen.forEach(it=> usedKeys.add(it.key));
  tilesWrap.innerHTML=''; linksSvg.innerHTML=''; selected=[];
  const flat=[]; currentPairs.forEach((p,idx)=>{ const key=`L${level}-${idx}`; const origKey = chosen[idx].key; flat.push({id:`${key}-a`,text:p[0],pair:key,origKey}); flat.push({id:`${key}-b`,text:p[1],pair:key,origKey}); });
  shuffle(flat); tiles=flat;
  for(const t of tiles){ const btn=document.createElement('button'); btn.className='tile appear'; btn.textContent=t.text; btn.dataset.id=t.id; btn.dataset.pair=t.pair; btn.dataset.orig=t.origKey; btn.addEventListener('click',()=>onSelect(btn)); tilesWrap.appendChild(btn); }
  setText('lvlPill',`Level ${level} (${diff})`); setText('pairsPill',`${currentPairs.length} å¯¹/pairs`);
  updateProgress(); updateComboChip();
}

function onSelect(el){
  if(el.classList.contains('matched')) return; if(selected.includes(el)) return; el.classList.add('selected'); selected.push(el);
  if(selected.length===2){
    const [a,b]=selected; const match=a.dataset.pair===b.dataset.pair && a!==b; drawLink(a,b,match);
    setTimeout(()=>{
      if(match){
        a.classList.remove('selected'); b.classList.remove('selected');
        streaks[turn]=(streaks[turn]||0)+1; const pts=1+Math.min(4,streaks[turn]-1); scores[turn]+=pts; wrongStreaks[turn]=0; updateScorePills();
        changeMyScore(pts);
        const m=midPoint(a,b); sfxCorrect(); spawnBubbles(m.x,m.y,20);
        bubblePop(a); bubblePop(b);
        updateProgress(); showCombo(streaks[turn]||1); sfxCombo(Math.min(5,streaks[turn]||1)); updateComboChip();
      } else {
        a.classList.remove('selected'); b.classList.remove('selected'); vibrate(120); screenShake(); sfxError();
        streaks[turn]=0; wrongStreaks[turn]=(wrongStreaks[turn]||0)+1;
        if(level>=3 && wrongStreaks[turn]>=2){ scores[turn]=Math.max(0,(scores[turn]||0)-1); showPenalty('-1'); const m=midPoint(a,b); spawnBomb(m.x,m.y); changeMyScore(-1); }
        updateScorePills(); updateComboChip(); turn=(turn+1)%players;
      }
      selected=[]; 
      setTimeout(()=>{
        const remaining = document.querySelectorAll('.tile:not(.matched)').length;
        if(remaining===0){ try{ clearInterval(timer); }catch(e){} confettiRain(); nextLevel(); }
      }, 240);
    },150);
  }
}

function startTimer(){
  if(timer) clearInterval(timer);
  const timeEl=$('timeLeft');
  let timeLeft=parseInt(timerInput.value||0)||0; setText('timeLeft', timeLeft);
  if(timeLeft>0){
    timer=setInterval(()=>{
      timeLeft--; setText('timeLeft', timeLeft);
      if(timeLeft<=0){ clearInterval(timer); document.querySelectorAll('.tile').forEach(t=>t.disabled=true); confettiRain(600); nextLevel(); }
    },1000);
  }
}

function initPool(){
  const raw=(dataEl && dataEl.value.trim()) || samples[modeEl.value];
  const arr=parsePairs(raw);
  if(arr.length<2){ alert('è¯·è‡³å°‘æä¾› 2 å¯¹é…å¯¹'); return false;}
  fullDataset=arr.slice(); pool=arr.slice(); shuffle(pool); bucketize(); reviewQueue=[]; usedKeys.clear(); return true;
}
function buildBoard(){ dealLevel(); }

function startGame(){
  players = parseInt(playersEl.value,10) || 1;
  scores=Array(players).fill(0); streaks=Array(players).fill(0); wrongStreaks=Array(players).fill(0); turn=0;
  buildScorePills();
  let seedStr=(seedInput.value || new URLSearchParams(location.search).get('seed') || '').trim();
  if(!seedStr){ seedStr=Math.random().toString(36).slice(2,8);} seedInput.value=seedStr;
  rng=mulberry32(xmur3(seedStr)());
  phase='initial'; level=1;
  if(!initPool()) return; setModeStatus(); timerInput.value=120; buildBoard(); startTimer();
}
function nextLevel(){ level++; if(phase==='initial' && pool.length===0){ phase='timed'; timerInput.value=120; } buildBoard(); startTimer(); }

/* Firebase åœ¨çº¿ï¼ˆCompatï¼‰ */
let fbApp=null, fbAuth=null, fbDB=null, myUID=null, myName='', myRoom='', fbReady=false; 
const DEFAULT_FB_CONFIG = {
  apiKey: "AIzaSyD-UMbgWjRyDroRJ87XaKt-ZBEmWqoL6aE",
  authDomain: "word-match-game-7edab.firebaseapp.com",
  databaseURL: "https://word-match-game-7edab-default-rtdb.firebaseio.com",
  projectId: "word-match-game-7edab",
  storageBucket: "word-match-game-7edab.firebasestorage.app",
  messagingSenderId: "1067109195215",
  appId: "1:1067109195215:web:ac076863f4db3ecbea86ba",
  measurementId: "G-98ELE2JDNK"
};
function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }
async function fbEnsure(){
  if(fbReady) return true;
  var cfgEl = document.getElementById('olCfg');
  var cfgText = localStorage.getItem('wmb_fb_cfg') || (cfgEl ? cfgEl.value : '');
  var cfg=null;
  if(cfgText && cfgText.trim()){ try{ cfg=JSON.parse(cfgText); }catch(e){ cfg=null; } }
  if(!cfg) cfg=DEFAULT_FB_CONFIG;
  await loadScript('https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js');
  await loadScript('https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js');
  await loadScript('https://www.gstatic.com/firebasejs/10.12.3/firebase-database-compat.js');
  fbApp = firebase.initializeApp(cfg);
  fbAuth = firebase.auth();
  fbDB = firebase.database();
  await fbAuth.signInAnonymously();
  fbAuth.onAuthStateChanged(u=>{ if(u){ myUID=u.uid; } });
  fbReady=true;
  return true;
}
async function olJoin(){ if(!(await fbEnsure())) return; myName=($('olName').value||'Player').trim().slice(0,24); myRoom=($('olRoom').value||'room').trim().replace(/[^a-zA-Z0-9_-]/g,''); if(!myRoom){ alert('è¯·è¾“å…¥æˆ¿é—´å·'); return; }
  localStorage.setItem('wmb_last_name', myName); saveRoomForName(myName, myRoom);
  const base='rooms/'+myRoom; const playerRef=fbDB.ref(base+'/players/'+myUID);
  await playerRef.set({ name: myName, online:true, joinedAt: firebase.database.ServerValue.TIMESTAMP });
  try{ playerRef.onDisconnect().update({ online:false, lastSeen: firebase.database.ServerValue.TIMESTAMP }); }catch(e){}
  const scoresRef=fbDB.ref(base+'/scores');
  scoresRef.on('value', snap=>{
    const val=snap.val()||{};
    const rows = Object.keys(val).map(uid=>({ uid, name:val[uid].name||'P', score:Number(val[uid].score||0) }));
    rows.sort((a,b)=>b.score-a.score);
    liveBoard.innerHTML = rows.map((r,i)=>`<li>${i+1}. ${r.name} â€” ${r.score} pts${r.uid===myUID?' â­':''}</li>`).join('');
    setText('olStatus','æˆ¿é—´ '+myRoom+' Â· åœ¨çº¿äººæ•° '+rows.length);
  });
}
async function olLeave(){ if(!fbReady||!myRoom||!myUID) return; await fbDB.ref('rooms/'+myRoom+'/players/'+myUID).update({ online:false }); setText('olStatus','å·²ç¦»å¼€ Left'); }
async function changeMyScore(delta){ if(!fbReady||!myRoom||!myUID) return; const ref=fbDB.ref('rooms/'+myRoom+'/scores/'+myUID); const snap=await ref.get(); const cur=snap.exists()?Number(snap.val().score||0):0; await ref.set({ name: myName||'Player', score: Math.max(0, cur + Number(delta||0)) }); }

/* æœ¬åœ°æŒä¹…æˆ¿é—´å†å²ï¼ˆæŒ‰åå­—ï¼‰ */
function roomsKey(name){ return 'wmb_rooms_'+(name||'').trim(); }
function loadRoomsByName(name){ try{ return JSON.parse(localStorage.getItem(roomsKey(name))||'[]'); }catch(e){ return []; } }
function renderRoomsDatalist(name){ const dl=document.getElementById('recentRooms'); if(!dl) return; dl.innerHTML=''; const list=loadRoomsByName(name); for(const r of list){ const opt=document.createElement('option'); opt.value=r; dl.appendChild(opt);} }
function saveRoomForName(name,room){ if(!name||!room) return; const list=loadRoomsByName(name).filter(r=>r!==room); list.unshift(room); localStorage.setItem(roomsKey(name), JSON.stringify(list.slice(0,10))); renderRoomsDatalist(name); }

/* è‡ªæµ‹ */
function runParseTests(){
  const cases=[
    {in:"a | 1\nb | 2", expect:2, label:'LF'},
    {in:"a | 1\r\nb | 2\r\n", expect:2, label:'CRLF'},
    {in:"\n\na | 1\n\n b | 2 ", expect:2, label:'trim'},
    {in:"term | a | b | c", expect:1, label:'pipe-join'},
    {in:"onlyterm\nterm | def", expect:1, label:'invalid-line-skip'}
  ];
  let ok=true; for(const c of cases){ const got=parsePairs(c.in).length; if(got!==c.expect){ ok=false; console.warn('parsePairs test failed', c.label, 'got', got, 'expect', c.expect); } }
  try{ const _p = players; if(typeof _p!== 'number'){ ok=false; console.warn('players not a number'); } }catch(e){ ok=false; console.error('players reference error', e); }
  console.log('self tests', ok?'OK âœ…':'FAIL âŒ');
}

/* äº‹ä»¶ */
window.addEventListener('DOMContentLoaded',()=>{
  modeEl.addEventListener('change',()=>{ if(dataEl) dataEl.value=samples[modeEl.value]||''; setModeStatus(); });
  startBtn.addEventListener('click', startGame);
  shuffleBtn.addEventListener('click', buildBoard);
  if(sndBtn) sndBtn.addEventListener('click', toggleSound);
  dataEl.value = samples[modeEl.value]; setModeStatus();
  $('olApplyCfg').addEventListener('click',()=>{ const j=prompt('ç²˜è´´ Firebase Web é…ç½® JSONï¼š'); if(!j) return; try{ JSON.parse(j); localStorage.setItem('wmb_fb_cfg', j); $('olCfg').value=j; alert('å·²ä¿å­˜é…ç½®'); }catch(e){ alert('JSON æ— æ•ˆ'); } });
  $('olJoin').addEventListener('click', olJoin);
  $('olLeave').addEventListener('click', olLeave);
  const lastName = localStorage.getItem('wmb_last_name'); if(lastName && $('olName')){ $('olName').value = lastName; renderRoomsDatalist(lastName); }
  const nameInp=$('olName'); if(nameInp){ nameInp.addEventListener('input', ()=> renderRoomsDatalist(nameInp.value)); nameInp.addEventListener('change', ()=> renderRoomsDatalist(nameInp.value)); }
  const saved=localStorage.getItem('wmb_fb_cfg'); if(saved){ $('olCfg').value=saved; } else { try{ $('olCfg').value = JSON.stringify(DEFAULT_FB_CONFIG, null, 2); }catch(e){} }
  $('olStatus').textContent = 'æœªè¿æ¥ Not connectedï¼ˆå·²å†…ç½®é…ç½®ï¼Œå¯ç›´æ¥ Joinï¼‰';
  runParseTests();
});
</script>
</body>
</html>
